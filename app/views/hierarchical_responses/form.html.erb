<% content_for(:per_page_js, javascript_google_maps) %>
<% @title_args = {id: @response.decorate.shortcode} %>

<%# This needs to be up here so it runs before the MediaUploaderViews are initialized. %>
<%= javascript_doc_ready do %>
  ELMO.mediaUploaderManager = new ELMO.Views.MediaUploaderManager(<%=json(
    el: ".response_form",
    preview_template: render("responses/answers/dropzone_preview")
  )%>);
<% end %>

<div id="response-form-wrapper">
  <% # TODO: this can be removed once `hierarchical_responses` is renamed to `responses` %>
  <% url = @response.new_record? ? hierarchical_responses_path : hierarchical_response_path(@response) %>
  <%= elmo_form_for(@response, read_only: @read_only, override_class: "response-form", url: url) do |f| %>
    <%= f.base_errors %>
    <%= f.field(:form_id, type: :hidden) %>

    <%= render("metadata", f: f, context: @context) %>
    <%= render("hierarchical_responses/answers/nodes", nodes: [@response.root_node_including_tree(:form_item, :option, :response, options: {option_nodes: :option})], context: @context) %>

    <div class="row">
      <div class="col-sm-6">
        <% if @context.read_only? %>
          <% if @response.incomplete %>
            <div class="answer">
              <div data-field-name="incomplete">
                <div class="hint-wrapper">
                  <div class="hint">
                    <em>This is an incomplete response</em>
                    <i class="hint fa fa-2x fa-info-circle"></i>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <%= f.field(:incomplete, type: :check_box) if can?(:submit_incomplete, @response) %>
        <% end %>
      </div>
      <div class="col-sm-6">
        <div class="submit-buttons">
          <% if form_mode == :edit && can?(:review, @response) %>
            <%= f.submit(t("response.save_and_mark_reviewed"),
                  class: "btn btn-default", name: "commit_and_mark_reviewed", read_only: false) %>
          <% end %>
          <% unless @context.read_only? %>
            <%= f.submit(class: "btn btn-primary") %>
          <% end %>
          <div id="upload-progress-notice" class="btn btn-default" disabled="disabled">
            <%= image_tag("load-ind-small.gif") %>
            <%= t("response.upload_progress_notice") %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%= render("layouts/location_picker") %>
</div>

<%= javascript_doc_ready do %>
  new ELMO.Views.HierarchicalResponseFormView(<%=json(
    el: "#response-form-wrapper",
    submitter_url: @response.new_record? ? possible_users_new_response_path(search_mode: "submitters") :
      possible_users_response_path(@response, search_mode: "submitters"),
    reviewer_url: @response.new_record? ? possible_users_new_response_path(search_mode: "reviewers") :
      possible_users_response_path(@response, search_mode: "reviewers")
  )%>);
<% end %>
